name: CI

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: monitor
                    POSTGRES_PASSWORD: password
                    POSTGRES_DB: monitoring_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd "pg_isready -U monitor" 
                    --health-interval 10s 
                    --health-timeout 5s 
                    --health-retries 5

        env:
            # Common DB env for both Python and Go tests
            POSTGRES_USER: monitor
            POSTGRES_PASSWORD: password
            POSTGRES_DB: monitoring_db
            POSTGRES_HOST: 127.0.0.1
            POSTGRES_PORT: 5432

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Python deps (devices backend)
              working-directory: devices/backend
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install -r requirements-test.txt

            - name: Run Python tests (devices backend)
              working-directory: devices/backend/src
              env:
                  DATABASE_URL: postgresql+asyncpg://monitor:password@127.0.0.1:5432/monitoring_db
                  SECRET_KEY: test-secret
                  ACCESS_TOKEN_EXPIRE_MINUTES: 10080
                  MINIO_ENDPOINT: http://127.0.0.1:9000
                  MINIO_ACCESS_KEY: minio
                  MINIO_SECRET_KEY: miniosecret
                  MINIO_SECURE: "false"
                  MENTOR_API_URL: http://127.0.0.1:8080
              run: |
                  pytest -q

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.23.x"

            - name: Go test (mentor backend)
              working-directory: mentor/backend/src
              env:
                  POSTGRES_USER: monitor
                  POSTGRES_PASSWORD: password
                  POSTGRES_DB: monitoring_db
                  POSTGRES_HOST: 127.0.0.1
                  POSTGRES_PORT: "5432"
              run: |
                  go mod download
                  go test ./... -v

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install and test mentor frontend
              working-directory: mentor/frontend
              run: |
                  npm ci || npm install
                  npm run test -- --run

            - name: Install and test devices frontend
              working-directory: devices/frontend
              run: |
                  npm ci || npm install
                  npm run test -- --run
