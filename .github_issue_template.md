# üîß Database Schema Alignment Issue - SQLAlchemy Models Don't Match Database Schema

## üéØ Problem Summary
The SQLAlchemy models in the devices backend don't match the definitive database schema defined in `db/modern_schema.sql`. This is causing:
- 500 Internal Server Error on screenshot uploads
- Empty lists for processes, activities, and alerts in the dashboard
- Foreign key constraint violations
- Column name mismatches between ORM and database

## üìã Current State

### ‚úÖ What's Working
- Database schema is properly defined in `db/modern_schema.sql` (treat as BIBLE - DO NOT TOUCH)
- Basic device registration and metrics posting
- Screenshots table structure is correct after manual fix
- Docker images latest built and pushed to registry

### ‚ùå What's Broken
- SQLAlchemy models use wrong column names and types
- API endpoints return 500 errors due to schema mismatches
- Foreign key relationships not properly implemented in ORM
- Dashboard shows empty lists for aggregated data

## üîç Detailed Analysis

### Database Schema (DEFINITIVE - from `db/modern_schema.sql`)
```sql
-- Core device table
CREATE TABLE devices (
    device_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    devicename TEXT,
    device_type TEXT,
    os TEXT,
    last_seen TIMESTAMP DEFAULT NOW(),
    is_online BOOLEAN,
    device_location TEXT,
    ip_address TEXT,
    mac_address TEXT,
    current_user_text TEXT
);

-- Device metrics
CREATE TABLE device_metrics (
    metrics_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL,  -- UUID, not TEXT!
    metrics_timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    cpu_usage NUMERIC,
    -- ... other fields
);

-- Device processes
CREATE TABLE device_processes (
    processes_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL,
    processes_timestamp TIMESTAMP DEFAULT NOW(),
    pid INTEGER NOT NULL,
    pname TEXT NOT NULL,  -- Column name is 'pname', not 'name'
    cpu NUMERIC,
    memory BIGINT,
    command TEXT
);

-- Similar issues in device_activities, device_alerts, etc.
```

### Current SQLAlchemy Models (INCORRECT)
```python
# devices/backend/src/app/models/devices.py
class Device(Base):
    __tablename__ = "devices"
    id = Column(Text, primary_key=True)  # WRONG: should be device_id UUID
    name = Column(Text)                  # WRONG: should be devicename
    type = Column(Text)                  # WRONG: should be device_type
    location = Column(Text)              # WRONG: should be device_location
    current_user = Column(Text)          # WRONG: should be current_user_text

class DeviceMetric(Base):
    __tablename__ = "device_metrics"
    id = Column(UUID...)                 # WRONG: should be metrics_id
    device_id = Column(Text...)          # WRONG: should be UUID, not Text
    timestamp = Column(TIMESTAMP...)     # WRONG: should be metrics_timestamp

class Process(Base):
    __tablename__ = "device_processes"
    id = Column(UUID...)                 # WRONG: should be processes_id
    device_id = Column(Text...)          # WRONG: should be UUID
    name = Column(Text...)               # WRONG: should be pname
    timestamp = Column(TIMESTAMP...)     # WRONG: should be processes_timestamp
```

## üöß Required Fixes

### 1. Update SQLAlchemy Models
**File:** `devices/backend/src/app/models/devices.py`

Must update ALL model classes to match the schema exactly:
- Change column names to match database schema
- Change `device_id` from `Text` to `UUID` in all related tables
- Update primary key names (e.g., `id` ‚Üí `device_id`, `metrics_id`, etc.)
- Fix timestamp column names
- Add proper foreign key relationships

### 2. Update API Endpoints
**File:** `devices/backend/src/app/api/v1/endpoints/devices.py`

- Update field references to match new column names
- Fix device registration logic for UUID primary keys
- Update all queries to use correct column names
- Add missing aggregate endpoints for dashboard:
  - `GET /api/v1/devices/processes` (currently missing)
  - `GET /api/v1/devices/activities` (currently missing)  
  - `GET /api/v1/devices/alerts` (currently missing)

### 3. Update Other Model Files
- `devices/backend/src/app/models/screenshots.py`
- `devices/backend/src/app/models/users.py`
- `devices/backend/src/app/models/locations.py`
- `devices/backend/src/app/models/keystrokes.py`

### 4. Database Migration
Since models will change significantly:
1. Stop services: `./stop.sh`
2. Delete PVCs: `kubectl delete pvc --all -n default`
3. Start fresh: `./start.sh`
4. Let SQLAlchemy `create_all()` use new models

## üéØ Acceptance Criteria

### ‚úÖ Success Metrics
- [ ] No 500 errors on any API endpoints
- [ ] Screenshot upload works without errors
- [ ] Dashboard shows actual data for:
  - [ ] Processes list (not empty)
  - [ ] Activities list (not empty)
  - [ ] Alerts list (not empty)
  - [ ] Screenshots list (working)
- [ ] Device registration creates proper UUID foreign keys
- [ ] All API endpoints return data in correct format
- [ ] Backend logs show no SQLAlchemy errors

### üß™ Test Cases
```bash
# 1. Device registration should work
curl -X POST "http://localhost:30080/api/v1/devices/register" \
  -H "Content-Type: application/json" \
  -d '{"id": "test-device", "name": "Test Device"}'

# 2. Metrics posting should work  
curl -X POST "http://localhost:30080/api/v1/devices/test-device/metrics" \
  -H "Content-Type: application/json" \
  -d '{"cpu_usage": 50.0, "memory_used": 1024}'

# 3. All aggregate endpoints should return data
curl "http://localhost:30080/api/v1/devices/processes"
curl "http://localhost:30080/api/v1/devices/activities"  
curl "http://localhost:30080/api/v1/devices/alerts"
curl "http://localhost:30080/api/v1/screenshots/"

# 4. Frontend should show data
# Visit http://localhost:4001 - all lists should show actual data
```

## üö® Important Notes

- **DO NOT modify `db/modern_schema.sql`** - treat it as the definitive source of truth
- **ALL code must be updated to match the schema**, not the other way around
- Use UUID foreign keys consistently throughout the system
- Maintain backward compatibility where possible
- Test thoroughly after each model change

## üìÅ Files to Modify
```
devices/backend/src/app/models/devices.py          (HIGH PRIORITY)
devices/backend/src/app/api/v1/endpoints/devices.py (HIGH PRIORITY)
devices/backend/src/app/models/screenshots.py      (MEDIUM)
devices/backend/src/app/models/users.py            (MEDIUM)
devices/backend/src/app/models/locations.py        (LOW)
devices/backend/src/app/models/keystrokes.py       (LOW)
```

## üîÑ Dependencies
- Requires Docker image rebuild after model changes
- May need Helm chart updates if API structure changes
- Frontend might need updates if response format changes

---
**Expected Resolution Time:** 2-4 hours  
**Priority:** üî• Critical - Blocking dashboard functionality  
**Complexity:** Medium - Straightforward schema alignment task